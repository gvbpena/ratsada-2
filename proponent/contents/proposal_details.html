<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposal Details</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/proposal_details.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container my-5">
        <div class="proposal-details">
            <h1 class="text-center mb-4">Proposal Detailsss</h1>
            <div class="row">
                <div class="col-md-6">
                    <div class="detail">
                        <h4>Title of Proposal</h4>
                        <p id="title"></p>
                        <input type="text" id="title-input" class="form-control" style="display: none;">
                    </div>
                    <div class="detail">
                        <h4>Name of the Proponent/s</h4>
                        <p id="proponent"></p>
                        <input type="text" id="proponent-input" class="form-control" style="display: none;">
                    </div>
                    <div class="detail">
                        <h4>Office/Unit</h4>
                        <p id="office"></p>
                        <input type="text" id="office-input" class="form-control" style="display: none;">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="detail">
                        <h4>Program/Project Description</h4>
                        <p id="description"></p>
                        <textarea id="description-input" class="form-control" rows="5" style="display: none;"></textarea>
                    </div>
                    <div class="detail">
                        <h3 id="status-label" style="display: none;"></h3>
                    </div>
                </div>
                <button id="edit-button" class="btn btn-success" style="display: none;">Edit</button>
                <button id="save-button" class="btn btn-primary" style="display: none;">Save</button>
            </div>
        </div>
        <div class="buttons text-center mt-5">
            <button id="view-documents" class="btn btn-primary mr-3">Download Files</button>
            <button id="view-certificate" class="btn btn-success mr-3" style="display: none;">View Certificate</button>
        </div>
       
    </div>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script>
$(document).ready(function() {
    console.log("Hello world");

    // Function to parse query parameters
    function getQueryParam(param) {
        var urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }

    // Fetch proposal details
    var proposalId = getQueryParam('id');
    
    function fetchProposalDetails() {
        return $.ajax({
            url: '../../controller/proposer/fetch_proposal_details.php?id=' + proposalId,
            type: 'GET',
            dataType: 'json'
        });
    }

    function fetchDocumentDetails() {
        return $.ajax({
            url: '../../controller/proposer/fetch_document_details.php?id=' + proposalId,
            type: 'GET',
            dataType: 'json'
        });
    }

    $.when(fetchProposalDetails(), fetchDocumentDetails()).done(function(proposalResponse, documentResponse) {
        console.log('Proposal Details Response:', proposalResponse);
        console.log('Document Details Response:', documentResponse);


    // Rest of your code...

        var proposal = proposalResponse[0];
        var documentDetails = documentResponse[0];

        console.log(proposal)
        console.log(documentDetails)
        console.log(JSON.parse(JSON.parse(documentDetails[0].document_file)))

        // Populate proposal details on the page
        $('#title').text(proposal.title);
        $('#proponent').text(proposal.proponent_name);
        $('#office').text(proposal.office);
        $('#description').text(proposal.description);

        // Show View Certificate button if status is Complete
        if (proposal.status === 'Completed') {
            $('#view-certificate').show();
        }

        // Show Edit button if status is Pending
        if (proposal.status === 'pending') {
            $('#edit-button').show();
        }

        // Process document details
        try {
            var documentFile = JSON.parse(JSON.parse(documentDetails[0].document_file));
            var totalScore = documentFile.reduce((sum, item) => sum + item.score, 0);
            console.log(totalScore)
            if (totalScore <= 7.9) {
                $('#view-certificate').hide();
                $('#status-label').text('Rejected').show();
            } else {
                $('#status-label').text('Accepted').show();
            }
        } catch (e) {
            console.error('Error parsing document file:', e);
            $('#status-label').text('Error processing document details').show();
        }
    }).fail(function(xhr, status, error) {
        console.error('Error:', error);
        // Handle error
    });

    // Event listener for View Documents button
    $('#view-documents').click(function() {
        // Get the proposal ID from the URL
        var proposalId = getQueryParam('id');
        console.log(proposalId);
        if (proposalId) {
            // Redirect to download the document based on the proposal ID
            window.location.href = '../../controller/proposer/download_proposal.php?id=' + proposalId;
        } else {
            // Proposal ID not found in the URL, handle accordingly
            alert('Proposal ID not found.');
        }
    });

    // Event listener for View Certificate button
    $('#view-certificate').click(function() {
        // Get the proposal ID from the URL
        var proposalId = getQueryParam('id');
        console.log(proposalId);
        if (proposalId) {
            // Redirect to view the certificate based on the proposal ID
            window.location.href = 'hgdg_details.html?id=' + proposalId;
        } else {
            // Proposal ID not found in the URL, handle accordingly
            alert('Proposal ID not found.');
        }
    });

    // Event listener for Edit button
    $('#edit-button').click(function() {
        // Hide the text elements
        $('#title').hide();
        $('#proponent').hide();
        $('#office').hide();
        $('#description').hide();

        // Show the input elements
        $('#title-input').val($('#title').text()).show();
        $('#proponent-input').val($('#proponent').text()).show();
        $('#office-input').val($('#office').text()).show();
        $('#description-input').val($('#description').text()).show();

        // Show the Save button and hide the Edit button
        $('#save-button').show();
        $('#edit-button').hide();
    });

    // Event listener for Save button
    $('#save-button').click(function() {
        var updatedDetails = {
            id: proposalId,
            title: $('#title-input').val(),
            proponent_name: $('#proponent-input').val(),
            office: $('#office-input').val(),
            description: $('#description-input').val()
        };

        $.ajax({
            url: '../../controller/proposer/update_proposal_details.php',
            type: 'POST',
            data: JSON.stringify(updatedDetails),
            contentType: 'application/json',
            success: function(response) {
                console.log(response);
                if (response.status === 'success') {
                    // Update the text elements with new values
                    $('#title').text(updatedDetails.title).show();
                    $('#proponent').text(updatedDetails.proponent_name).show();
                    $('#office').text(updatedDetails.office).show();
                    $('#description').text(updatedDetails.description).show();

                    // Hide the input elements
                    $('#title-input').hide();
                    $('#proponent-input').hide();
                    $('#office-input').hide();
                    $('#description-input').hide();

                    // Show the Edit button and hide the Save button
                    $('#edit-button').show();
                    $('#save-button').hide();
                } else {
                    alert('Error updating proposal details');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                // Handle error
                alert('Error updating proposal details');
            }
        });
    });
});
    </script>
</body>
</html>
